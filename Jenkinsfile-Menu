//////

def brch= scm.branches.toString().substring(3,9)
library("groovytest-shared-lib@$brch") _
println "------branch=${brch}"
menu.getEnvar()
wksp=env.WKSP
build_no =env.BLDNo
repo=env.REPO
brch=env.BRCH
jobstr=env.JOBSTR
println "------wksp=${wksp}"
println "------jobstr=${jobstr}"
println "------build_no=${build_no}"
println "------repo=${repo}"
println "------brch=${brch}"

println "call getFileList"
println menu.getFileList('solution',wksp) 
println "call getContent100"
println menu.getContent100('SolutionDetail' ,wksp,repo,brch )
println "begin properties"
//////
properties([
    pipelineTriggers([githubPush()]),
    parameters([
            choice( name: 'Soltail', description: '', choices: [ brch,jobstr,repo] ),
          
            choice( name: 'SolutionDetail', description: '', choices: menu.getFileList('solution',wksp) ),
            
            [$class: 'DynamicReferenceParameter', choiceType: 'ET_FORMATTED_HTML', name: 'CONFIG', omitValueField: false, 
            randomName: 'choice-parameter-138673186839723', referencedParameters: 'SolutionDetail', 
            script: [$class: 'GroovyScript', fallbackScript: [classpath: [], oldScript: '', sandbox: false, script: ''],
                     script: [classpath: [], oldScript: '', sandbox: false, 
                              script: menu.getContent100('SolutionDetail' ,wksp,repo,brch )]] ],

            string(name: 'filebackup', defaultValue: 'backup.yaml', description: 'input file to backup'),
             
])
])
println "begin pipeline"
def map
def list
pipeline {
    agent any
    stages {
        stage('Create List') {
            steps {
                script {
                    echo "STAGE: create List..."
                    echo "params=$params"
                    echo "parsing yaml"
                    println env.CONFIG 
                    if ( env.CONFIG == '' ){
                        echo "CONFIG is not SET"
                        sh 'exit 1'
                    }
                    ///println for yaml string
                    //def multiLineStr = params.CONFIG.replaceAll(/\\n/,"\n").replaceAll(',','')
                    println "for comma string"
                    def read = menu.stringParse(env.CONFIG)
                    println read
                    
                    //writeYaml file: "releases/${filebackup}", data: read
                    //writeFile file: "releases/${filebackup}", text: multiLineStr
                    menu.writeYamlFile("releases/${filebackup}",read)
                    sh "cat releases/${filebackup}"
                   
                    
                    
                    /*def targtServer=params.servers
                    echo "params=$params"
                    if ( targtServer.equals('ERROR') ) 
                    {
                        targtServer='s23'
                    }
                    
                    echo "targtServer=$targtServer"
                    workspace=WORKSPACE
                    println "WS=${env.WORKSPACE}"
                    println "WS=${WORKSPACE}"
                    println "pwd="+pwd()
                    println "workspace=$workspace"
                    // you may create your list here, lets say reading from a file after checkout
                    //list = ["Test-1", "Test-2", "Test-3", "Test-4", "Test-5"]
                    list = readXMLList("${workspace}/manifest_Lynx.xml")
                    echo "***************"
                    def jsonText = parseXML("${workspace}/manifest_Lynx.xml")
                    map = readJSON text: jsonText
                    echo "#################"
                     def remote = [:]
                    remote.name = 'test'
                    remote.host = '192.168.2.27'
                    remote.user = 'root'
                    remote.password = 'password'
                    remote.allowAnyHosts = true
    
                    sshCommand remote: remote, command: "ls -lrt"*/
    
                }
            }
        }
   }
}


